---
title: "Untitled"
format: html
---

## ANALYSIS OF OLINK DATA OF MONOCYTE SBSETS AT BASELINE AND 24HR AFTER ECOLI INFECTION

### proteins from serum of classical, intermediate and non-classical monos measured in 1 patient

```{r}
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(RColorBrewer)
library(ggrepel)
```

### load in data and keep only relevant columns

### remove the 6 proteins with QC warnings

### remove the prefix from the sample_id column

### add subset and time columns

```{r}
df <- read_xlsx("Olink_fulldata.xlsx")
df <- df[, c(1,8,12,13,14,17)]
df <- filter(df, AssayQC %in% "PASS")
df$SampleID <- sub("AL_", "", x = df$SampleID)
df <- df %>% separate(SampleID, into = c("subset", "time"), sep = "_", remove = F)
```

## plot expression in IM vs CM at 24 hours
## filter for only needed data
## make subsets their own column
## make a difference column and set axis to be from 0 to max value
## get top genes by difference so that they can be labelled
```{r}
plot_input <- filter(df, time == "24h")
plot_input <- plot_input[, c(2,4,5)]
plot_input <- pivot_wider(plot_input, names_from = "subset", values_from = "Count")
plot_input <- plot_input %>%
  mutate(Difference = log(IM) - log(CM))
genes <- plot_input %>% arrange(desc(Difference)) %>% slice_head(n= 20)
max_dev <- max(abs(plot_input$Difference), na.rm = TRUE)
plot1 <- ggplot(plot_input, aes(x = log(IM), y = log(CM), fill = Difference))+
    geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black")+
    geom_point(shape = 21, colour = "black", size = 3)+
    xlim(0, max(log(plot_input$IM+1)))+ylim(0,max(log(plot_input$CM+1)))+
    theme_bw()+scale_fill_gradient2(low = "mediumseagreen", mid = "white", high = "darkorchid2", midpoint = 0)+
    theme(axis.text = element_text(size = 16, colour = "black"))+
    theme(axis.title = element_text(size = 16, colour = "black", face = "bold"))+
    xlab("Intermediate monocytes (log expression)")+
    ylab("Classical monocytes (log expression)")+
    theme(legend.text = element_text(size = 12),
    legend.title = element_text(size = 16, face = "bold"),
    legend.key.size = unit(1,"cm"))+
    geom_label_repel(
    data = genes,
    aes(label = Assay),
    fill = "white",
    colour = "black",
    size = 2.5,
    box.padding = 0.7,
    point.padding = 0.5,
    force = 1,
    segment.color = "black",
    max.overlaps = 100
  )
plot1
ggsave(plot = plot1, filename = "expression_24hr_classical_vs_inter.png", dpi = 500,
height = 5, width = 8)
```

## taking the top 20 genes most different between eachother to then assess for difference from baseline

```{r}
plot_input <- filter(df, Assay %in% genes$Assay)
plot_input <- filter(plot_input, subset %in% "IM")
plot_input <- plot_input[, c(3,4,5)]
plot_input <- plot_input %>%
  pivot_wider(names_from = time, values_from = Count) %>%
  mutate(Difference = log10(`24h`) - log10(baseline))
plot_input <- plot_input %>%
  pivot_longer(
    cols = c(baseline, `24h`),
    names_to = "time",
    values_to = "Count"
  )

plot2 <- ggplot(plot_input, aes(x = reorder(Assay, Difference), y = Count, colour = time,
shape = time, group=Assay))+
    geom_line(colour = "black")+
    geom_point(size=4)+
    theme_bw()+scale_y_log10()+scale_colour_manual(values = c("darkred","indianred"))+
    scale_shape_manual(values = c(15,19))+
    theme(axis.text = element_text(size = 16, colour = "black"))+
    theme(axis.title = element_text(size = 16, colour = "black", face = "bold"))+
    theme(legend.text = element_text(size = 12),
    legend.title = element_text(size = 16, face = "bold"),
    legend.key.size = unit(1,"cm"))+
    xlab("Gene")+ylab("Log10(Expression)")+coord_flip()
plot2
ggsave(plot = plot2, filename = "top20genes_IM_baseline_24hr.png", dpi = 500,
height = 5, width = 8)
```